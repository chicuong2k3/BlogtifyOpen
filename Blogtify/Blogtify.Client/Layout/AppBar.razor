@using Bit.BlazorUI

@inject NavigationManager NavigationManager
@inject AppDataManager AppDataManager
@inject BitThemeManager BitThemeManager

<div class="appbar" style="var(@(IsDark? BitCss.Var.Color.Tertiary.Dark : BitCss.Var.Color.Tertiary.Light))">
    <BitStack Horizontal VerticalAlign="BitAlignment.Center">
        <div>
            <BitButton OnClick="OnToggleDrawer" AriaLabel="Bật tắt menu"
                       IconName="@BitIconName.ContextMenu"
                       Color="BitColor.Primary"
                       Class="toggle-menu-btn"
                       Style="padding: calc(var(--bit-spa-scaling-factor) * 0.5) calc(var(--bit-spa-scaling-factor))" />
        </div>

        <div class="logo" style="height: 30px">
            <a href="/" style="outline: none; border: none" tabindex="-1">
                <img src="logo.webp" alt="CodeMagic" width="30" height="30" lazy-loading />
            </a>
        </div>

    </BitStack>
    <BitStack Horizontal HorizontalAlign="BitAlignment.End" Style="width: 100%; gap: 0.5rem;">
        
        <BitToggleButton OnIconName="@BitIconName.HazyNight" @bind-IsChecked="@IsDark"
                         OffIconName="@BitIconName.HazyDay"
                         AriaLabel="Dark Mode" Variant="BitVariant.Outline"
                         OnClick="@OnToggleTheme" 
                         Style="padding: calc(var(--bit-spa-scaling-factor) * 0.5) calc(var(--bit-spa-scaling-factor))" />

        <AuthorizeView>
            <Authorized>
                <form action="authentication/logout" method="post">
                    <AntiforgeryToken />
                    <input type="hidden" name="returnUrl" value="@NavigationManager.Uri" />
                    <BitButton ButtonType="BitButtonType.Submit">Đăng xuất</BitButton>
                </form>
                <BitPersona ImageUrl="https://example.com/avatar.jpg" 
                    Size="BitPersonaSize.Size32"  />
            </Authorized>
            <NotAuthorized>
                <BitButton ButtonType="BitButtonType.Button"
                           OnClick="@(() => NavigationManager.NavigateTo($"authentication/login?returnUrl={@Uri.EscapeDataString(NavigationManager.Uri)}", forceLoad: true))">
                    Đăng nhập
                </BitButton>
            </NotAuthorized>
        </AuthorizeView>
    </BitStack>

</div>

@code {
    private bool IsDark = false;

    [Parameter]
    public EventCallback OnToggleDrawer { get; set; }

    [Parameter]
    public EventCallback OnToggleTheme { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        var currentTheme = await BitThemeManager.GetCurrentThemeAsync();
        IsDark = currentTheme?.Contains("dark") ?? false;
        StateHasChanged();
    }


}
