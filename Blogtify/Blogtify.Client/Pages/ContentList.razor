@page "/"
@using Blogtify.Client.Services

@inject NavigationManager NavigationManager
@inject AppDataManager AppDataManager

<BitCard NoShadow FullWidth Background="BitColorKind.Transparent">

    <BitStack Gap="1rem">
        <BitText Typography="BitTypography.H1">Các bài viết</BitText>
        <BitStack Alignment="BitAlignment.End">
            <BitDropdown Items="_sortFilters" TItem="BitDropdownItem<string>"
                         TValue="string" AriaLabel="Sắp xếp theo" Label="Sắp xếp theo"
                         @bind-Value="_selectedSortValue"
                         OnChange="OnSortChanged" FitWidth="true">
            </BitDropdown>
        </BitStack>

        <BitShimmer Loaded="@(!_isLoading)"
                    Background="BitColor.Success" AriaLabel="Loading content" Height="1rem">

            @if (Contents is not null && Contents.Any())
            {
                <BitStack Gap="8px">
                    @foreach (var content in Contents.Take(_currentPage * Constants.PageSize))
                    {
                        <ContentCard Content="@content" @key="@content.GetHashCode()" />
                    }
                </BitStack>
            }
            else
            {
                <BitText Typography="BitTypography.Subtitle1" Style="font-weight: 600">Không có kết quả nào.</BitText>
            }

            @if (_hasMore)
            {
                <BitStack Alignment="BitAlignment.Center">
                    <BitButton OnClick="LoadMore"
                               IsLoading="_isLoading"
                               ButtonType="BitButtonType.Button" Style="margin-top: 8px">
                        Tải thêm
                    </BitButton>
                </BitStack>
            }

        </BitShimmer>

    </BitStack>


</BitCard>

@code {
    [PersistentState(AllowUpdates = true)]
    public List<ContentDto>? Contents { get; set; }
    private List<BitDropdownItem<string>> _sortFilters = new()
    {
        new() { Text = "Mới nhất", Value = "desc" },
        new() { Text = "Cũ nhất", Value = "asc" }
    };

    private int _currentPage = 1;
    private string _selectedSortValue = "desc";
    private bool _isLoading = true;
    private bool _hasMore => _currentPage * Constants.PageSize < Contents?.Count();

    [SupplyParameterFromQuery]
    public string Query { get; set; } = string.Empty;

    [SupplyParameterFromQuery(Name = "categories")]
    public string[] Categories { get; set; } = Array.Empty<string>();

    protected override async Task OnInitializedAsync()
    {
        await LoadPosts();
    }

    private async Task LoadPosts()
    {
        _isLoading = true;

        if (Contents == null)
        {
            Contents = await AppDataManager.GetContentsAsync(Query ?? string.Empty, Categories.ToList());
            Contents = Contents
                .OrderByDescending(c => c.LastModified ?? DateTime.MinValue)
                .ToList();
        }

        _isLoading = false;
    }

    private void LoadMore()
    {
        _currentPage++;
        StateHasChanged();
    }

    private async Task OnSortChanged(string value)
    {
        if (!string.IsNullOrEmpty(value))
        {
            _selectedSortValue = value;
            _currentPage = 1;
            Contents = _selectedSortValue?.ToLowerInvariant() switch
            {
                "asc" => Contents
                    ?.OrderBy(p => p.LastModified ?? DateTime.MinValue)
                    .ToList(),
                "desc" => Contents
                    ?.OrderByDescending(p => p.LastModified ?? DateTime.MinValue)
                    .ToList(),
                _ => Contents?.OrderBy(p => p.LastModified ?? DateTime.MinValue).ToList()
            };
        }
    }
}
